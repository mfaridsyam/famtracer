<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <meta name="theme-color" content="#0F3775"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="apple-mobile-web-app-title" content="TraceLink"/>
  <title>TraceLink</title>
  <link rel="manifest" href="manifest.json"/>
  <link rel="apple-touch-icon" href="icon-192.png"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>

<div class="toast-container" id="toastContainer"></div>

<div id="splash">
  <div class="splash-logo"><i class="fas fa-map-pin"></i></div>
  <div class="splash-title">Trace<span>Link</span></div>
  <div class="splash-sub" data-i18n="splashSub"></div>
  <div class="splash-dots">
    <div class="splash-dot"></div>
    <div class="splash-dot"></div>
    <div class="splash-dot"></div>
  </div>
</div>

<!-- Permission Screen -->
<div id="permission-screen">
  <div class="permission-card">
    <div class="card-top-controls">
      <button class="ctrl-pill lang-pill" onclick="toggleLang()">
        <span id="langLabelPerm">ID</span>
      </button>
      <button class="ctrl-pill theme-pill" onclick="toggleTheme()">
        <i class="fas fa-moon" id="themeIconPerm"></i>
      </button>
    </div>
    <div class="perm-icon"><i class="fas fa-location-crosshairs"></i></div>
    <h2 class="perm-title" data-i18n="permTitle"></h2>
    <p class="perm-desc" data-i18n="permDesc"></p>
    <div class="perm-notice">
      <div class="perm-notice-header">
        <i class="fas fa-shield-halved"></i>
        <span class="perm-notice-label" data-i18n="permNoticeLabel"></span>
      </div>
      <p class="perm-notice-body" data-i18n="permNoticeBody"></p>
    </div>
    <button class="btn-allow" onclick="requestLocation()">
      <i class="fas fa-location-dot"></i> <span data-i18n="btnAllow"></span>
    </button>
    <button class="btn-deny" onclick="showDenied()" data-i18n="btnDeny"></button>
  </div>
</div>

<!-- Denied Screen -->
<div id="denied-screen">
  <div class="denied-card">
    <div class="denied-icon"><i class="fas fa-circle-exclamation"></i></div>
    <h2 class="denied-title" data-i18n="deniedTitle"></h2>
    <p class="denied-desc" data-i18n="deniedDesc"></p>
    <button class="btn-retry" onclick="retryPermission()">
      <i class="fas fa-rotate-right"></i> <span data-i18n="btnRetry"></span>
    </button>
  </div>
</div>

<!-- Setup Screen -->
<div id="setup-screen">
  <div class="setup-card">
    <div class="setup-header">
      <div class="step-badge" data-i18n="stepBadge"></div>
      <h2 class="setup-title" data-i18n="setupTitle"></h2>
      <p class="setup-desc" data-i18n="setupDesc"></p>
    </div>
    <div class="form-group">
      <label data-i18n="labelName"></label>
      <input type="text" id="inputName" maxlength="20" autocomplete="off"/>
    </div>
    <div class="form-group">
      <label data-i18n="labelRole"></label>
      <select id="inputRole"></select>
    </div>
    <div class="form-group">
      <label data-i18n="labelRoom"></label>
      <div class="room-row">
        <input type="text" id="inputRoom" maxlength="6" autocomplete="off" inputmode="text"
               style="text-transform:uppercase;font-family:'DM Mono',monospace;letter-spacing:3px;font-size:16px;"/>
        <button class="btn-generate" onclick="generateRoom()">
          <i class="fas fa-dice"></i> <span data-i18n="btnRandom"></span>
        </button>
      </div>
      <small class="input-hint" data-i18n="roomHint"></small>
    </div>
    <button class="btn-start" onclick="startApp()">
      <i class="fas fa-rocket"></i> <span data-i18n="btnStart"></span>
    </button>
  </div>
</div>

<!-- Confirm Leave Modal -->
<div class="modal-overlay" id="confirmLeaveModal">
  <div class="modal-box confirm-modal-box">
    <div class="confirm-icon-wrap"><i class="fas fa-right-from-bracket"></i></div>
    <h3 class="confirm-title" data-i18n="confirmLeaveTitle"></h3>
    <p class="confirm-desc" data-i18n="confirmLeaveDesc"></p>
    <div class="confirm-actions">
      <button class="confirm-btn-cancel" onclick="closeConfirmLeave()" data-i18n="btnCancel"></button>
      <button class="confirm-btn-danger" onclick="doLeaveRoom()" data-i18n="btnLeave"></button>
    </div>
  </div>
</div>

<!-- Share Modal -->
<div class="modal-overlay" id="shareModal">
  <div class="modal-box">
    <h3 class="modal-title" data-i18n="shareTitle"></h3>
    <p class="modal-desc" data-i18n="shareDesc"></p>
    <div class="code-box">
      <span class="code-val" id="modalRoomCode">——</span>
      <button class="copy-btn" onclick="copyLink()"><i class="fas fa-link"></i> <span data-i18n="btnCopyLink"></span></button>
    </div>
    <div class="share-options">
      <button class="share-opt wa" onclick="shareWA()"><i class="fab fa-whatsapp"></i> WhatsApp</button>
      <button class="share-opt tele" onclick="shareTelegram()"><i class="fab fa-telegram"></i> Telegram</button>
    </div>
    <button class="modal-close-btn" onclick="closeModal()" data-i18n="btnClose"></button>
  </div>
</div>

<!-- Install Modal -->
<div class="modal-overlay" id="installModal">
  <div class="modal-box">
    <h3 class="modal-title"><i class="fas fa-download" style="color:var(--sky);margin-right:.5rem"></i><span data-i18n="installTitle"></span></h3>
    <p class="modal-desc" data-i18n="installDesc"></p>
    <div class="install-section">
      <div class="install-platform">
        <div class="install-platform-header">
          <div class="install-platform-icon android"><i class="fab fa-android"></i></div>
          <div class="install-platform-name">Android (Chrome)</div>
        </div>
        <div class="install-platform-body">
          <ol class="install-steps" id="androidSteps"></ol>
        </div>
      </div>
    </div>
    <div class="install-divider"></div>
    <div class="install-section">
      <div class="install-platform">
        <div class="install-platform-header">
          <div class="install-platform-icon ios"><i class="fab fa-apple"></i></div>
          <div class="install-platform-name">iPhone / iPad (Safari)</div>
        </div>
        <div class="install-platform-body">
          <ol class="install-steps" id="iosSteps"></ol>
        </div>
      </div>
    </div>
    <button class="modal-close-btn" onclick="closeInstallModal()" style="margin-top:.5rem" data-i18n="btnClose"></button>
  </div>
</div>

<!-- Main App -->
<div id="app">

  <div class="topbar">
    <div class="topbar-left">
      <div class="topbar-logo"><i class="fas fa-map-pin"></i></div>
      <div class="topbar-name">Trace<span>Link</span></div>
    </div>
    <div class="topbar-right">
      <!-- Desktop-only: theme + lang before room badge -->
      <button class="topbar-btn desktop-only" id="themeToggleApp" onclick="toggleTheme()">
        <i class="fas fa-moon" id="themeIconApp"></i>
      </button>
      <button class="topbar-btn lang-topbar-btn desktop-only" onclick="toggleLang()">
        <span id="langLabelApp">ID</span>
      </button>
      <div class="room-badge" onclick="openModal()">
        <i class="fas fa-users"></i>
        <span id="topbarRoomCode">——</span>
      </div>
      <button class="topbar-btn" onclick="openInstallModal()">
        <i class="fas fa-download"></i>
      </button>
      <button class="topbar-btn topbar-btn-exit" onclick="changeProfile()">
        <i class="fas fa-right-from-bracket"></i>
      </button>
    </div>
  </div>

  <div class="main-layout">

    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <span class="sidebar-title" data-i18n="sidebarTitle"></span>
        <div class="sidebar-header-right">
          <div class="online-count">
            <div class="online-dot"></div>
            <span id="onlineCount">1</span>&nbsp;<span data-i18n="onlineLabel"></span>
          </div>
          <!-- Mobile-only: theme + lang inside sidebar header, between online count and X -->
          <button class="sidebar-icon-btn mobile-only" onclick="toggleTheme()">
            <i class="fas fa-moon" id="themeIconMob"></i>
          </button>
          <button class="sidebar-icon-btn lang-icon-btn mobile-only" onclick="toggleLang()">
            <span id="langLabelMob">ID</span>
          </button>
          <button class="sidebar-close-btn" onclick="closeSidebar()">
            <i class="fas fa-xmark"></i>
          </button>
        </div>
      </div>

      <div class="sidebar-scroll">
        <div class="my-card" id="myCard">
          <div class="my-card-header">
            <div class="my-avatar" id="myAvatar">—</div>
            <div class="my-info">
              <div class="my-name" id="myCardName">—</div>
              <div class="my-role" id="myCardRole">—</div>
            </div>
            <div class="my-badge" data-i18n="badgeMe"></div>
          </div>
          <div class="my-card-divider"></div>
          <div class="my-card-rows">
            <div class="my-card-row">
              <i class="fas fa-crosshairs my-card-row-icon"></i>
              <span class="my-card-row-label" data-i18n="labelCoords"></span>
              <span class="my-card-row-val mono" id="myCoordsVal" data-i18n="loading"></span>
            </div>
            <div class="my-card-row" id="myLocationNameRow" style="display:none;">
              <i class="fas fa-map-marker-alt my-card-row-icon" style="color:#93c5fd"></i>
              <span class="my-card-row-label" data-i18n="labelLocation"></span>
              <span class="my-card-row-val" id="myLocationName">—</span>
            </div>
            <div class="my-card-row">
              <i class="fas fa-satellite-dish my-card-row-icon" style="color:#93c5fd"></i>
              <span class="my-card-row-label" data-i18n="labelAccuracy"></span>
              <span class="my-card-row-val" id="myAccuracy">—</span>
            </div>
            <div class="my-card-row">
              <i class="fas fa-clock my-card-row-icon" style="color:#93c5fd"></i>
              <span class="my-card-row-label" data-i18n="labelUpdate"></span>
              <span class="my-card-row-val" id="myUpdate">—</span>
            </div>
          </div>
        </div>

        <div class="members-section-label">
          <span data-i18n="otherMembers"></span>
        </div>

        <div class="members-list" id="membersList">
          <div class="no-members" id="noMembers">
            <i class="fas fa-users"></i>
            <p data-i18n="noMembersText"></p>
          </div>
        </div>

        <div class="sidebar-footer">
          <button class="share-btn" onclick="openModal()">
            <i class="fas fa-share-nodes"></i> <span data-i18n="btnInvite"></span>
          </button>
          <button class="stop-btn" id="stopBtn" onclick="stopSharing()">
            <i class="fas fa-location-slash"></i> <span data-i18n="btnStop"></span>
          </button>
        </div>
      </div>
    </div>

    <div class="map-wrapper">
      <button class="mob-toggle" id="mobToggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
      </button>
      <div class="map-status">
        <i class="fas fa-circle"></i>
        <span data-i18n="mapStatus"></span>&nbsp;·&nbsp;
        <span class="update-time" id="lastUpdate">—</span>
      </div>
      <div id="map"></div>
      <div class="map-controls">
        <button class="map-ctrl-btn" onclick="centerMyLocation()"><i class="fas fa-crosshairs"></i></button>
        <button class="map-ctrl-btn" onclick="fitAll()"><i class="fas fa-expand"></i></button>
        <button class="map-ctrl-btn" id="layerToggleBtn" onclick="openLayerPanel()"><i class="fas fa-layer-group"></i></button>
      </div>
      <div class="layer-panel" id="layerPanel">
        <div class="layer-panel-title" data-i18n="layerTitle"></div>
        <button class="layer-option active" id="layerStreet" onclick="setLayer('street')">
          <div class="layer-thumb layer-thumb-street"></div>
          <span data-i18n="layerStreet"></span>
        </button>
        <button class="layer-option" id="layerSatellite" onclick="setLayer('satellite')">
          <div class="layer-thumb layer-thumb-satellite"></div>
          <span data-i18n="layerSatellite"></span>
        </button>
      </div>
    </div>

  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, set, onValue, remove, onDisconnect, update }
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
  const firebaseConfig = {
    apiKey: "AIzaSyAVIFJIGFDv6EgHhac9aUF_g9ApehmDALQ",
    authDomain: "famtracer-d7725.firebaseapp.com",
    databaseURL: "https://famtracer-d7725-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "famtracer-d7725",
    storageBucket: "famtracer-d7725.firebasestorage.app",
    messagingSenderId: "586025840029",
    appId: "1:586025840029:web:e4e8af82cd563203171374"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  window._FB = { db, ref, set, onValue, remove, onDisconnect, update };
  window.dispatchEvent(new Event('firebaseReady'));
</script>
<script src="app.js"></script>
</body>
</html>